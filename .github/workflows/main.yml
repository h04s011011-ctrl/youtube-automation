name: Nature Canvas Animator Pro PNG
on:
  repository_dispatch:
    types: [start-build]
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: アニメーション合成（雨・光・音）
        run: |
          # 1. 音源をダウンロード
          curl -L "${{ github.event.client_payload.rain_url }}" -o rain.mp3
          curl -L "${{ github.event.client_payload.fire_url }}" -o fire.mp3

          # 2. FFmpegで合成
          # background.png をループさせ、雨(noise)と光の揺らぎ(eq)を追加
          ffmpeg -loop 1 -i background.png -i rain.mp3 -i fire.mp3 -filter_complex \
          "[0:v]scale=1920:1080:force_original_aspect_ratio=increase,crop=1920:1080, \
           noise=alls=15:allf=t+u, \
           eq=brightness='0.05*sin(t*10)+0.02*sin(t*23)'[v_effect]; \
           [1:a]pan=stereo|c0=0.8*c0|c1=0.4*c1[rain_spatial]; \
           [2:a]afade=t=in:st=2:d=5,pan=stereo|c0=0.3*c0|c1=0.9*c1[fire_spatial]; \
           [rain_spatial][fire_spatial]amix=inputs=2:duration=first[aout]" \
          -map "[v_effect]" -map "[aout]" -t 60 -c:v libx264 -pix_fmt yuv420p -c:a aac -shortest final_video.mp4

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Nature-Canvas-Animated-PNG
          path: final_video.mp4
