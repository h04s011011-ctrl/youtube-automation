name: Nature Canvas Precision Master
on:
  repository_dispatch:
    types: [start-build]

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: ç²¾å¯†ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°åˆæˆ
        run: |
          curl -L "${{ github.event.client_payload.rain_video }}" -o v_rain.mp4
          curl -L "${{ github.event.client_payload.fire_video }}" -o v_fire.mp4
          curl -L "${{ github.event.client_payload.rain_audio }}" -o a_rain.mp3
          curl -L "${{ github.event.client_payload.fire_audio }}" -o a_fire.mp3

          # --- ğŸ› ï¸ ç²¾å¯†èª¿æ•´ã®é­”æ³• ---
          # 1. é›¨ï¼ˆå°ç²’åŒ–ï¼‰: å‹•ç”»ã‚’1/3ã®ã‚µã‚¤ã‚ºã«ç¸®å°ã—ã€ãã‚Œã‚’3x3ã®ã‚°ãƒªãƒƒãƒ‰çŠ¶ã«ä¸¦ã¹ã¦æ•·ãè©°ã‚ã‚‹ã“ã¨ã§ã€
          #    å·¨å¤§ãªæ°´æ»´ã‚’ã€Œç¹Šç´°ãªå°ç²’ã®é›«ã€ã«å¤‰ãˆã¾ã™ã€‚
          # 2. ç‚ï¼ˆå°å‹åŒ–ï¼†é…ç½®ï¼‰: ã‚µã‚¤ã‚ºã‚’ã€Œ300x240ã€ã¾ã§å°ã•ãã—ã€æš–ç‚‰ã®å¥¥ï¼ˆx=260, y=920ï¼‰ã«é…ç½®ã€‚
          # 3. è‰²ï¼ˆå®Œå…¨ä¿æŒï¼‰: æœ€å¾Œã®åˆæˆã§ format=yuv420p ã‚’å³å®ˆã—ã€å…ƒã®è‰²å‘³ã‚’å£Šã—ã¾ã›ã‚“ã€‚

          ffmpeg -loop 1 -i background.png -i v_rain.mp4 -i v_fire.mp4 -i a_rain.mp3 -i a_fire.mp3 -filter_complex \
          "[1:v]scale=918:512,format=yuva420p,colorchannelmixer=aa=0.15[rain_small]; \
           [rain_small]split=9[r1][r2][r3][r4][r5][r6][r7][r8][r9]; \
           [r1][r2][r3]hstack=3[row1]; \
           [r4][r5][r6]hstack=3[row2]; \
           [r7][r8][r9]hstack=3[row3]; \
           [row1][row2][row3]vstack=3,scale=2752:1536[rain_tiled]; \
           [2:v]scale=300:240,boxblur=8,format=yuva420p[fire_small]; \
           color=black:s=2752x1536[black_bg]; \
           [black_bg][fire_small]overlay=x=260:y=920:shortest=1[fire_on_black]; \
           [0:v][rain_tiled]overlay=shortest=1:format=auto[bg_rain]; \
           [bg_rain][fire_on_black]blend=all_mode='lighten':all_opacity=1,format=yuv420p[v_final]; \
           [3:a]pan=stereo|c0=0.8*c0|c1=0.4*c1[rain_a]; \
           [4:a]afade=t=in:st=2:d=5,pan=stereo|c0=0.3*c0|c1=0.9*c1[fire_a]; \
           [rain_a][fire_a]amix=inputs=2:duration=first[aout]" \
          -map "[v_final]" -map "[aout]" -t 60 -c:v libx264 -pix_fmt yuv420p -c:a aac final_video.mp4

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Nature-Canvas-Precision-Result
          path: final_video.mp4
