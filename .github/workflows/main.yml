name: Nature Canvas Zero-Cost Perfect
on:
  repository_dispatch:
    types: [start-build]

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: 究極の0円合成（エラー＆紫化解消版）
        run: |
          curl -L "${{ github.event.client_payload.rain_video }}" -o v_rain.mp4
          curl -L "${{ github.event.client_payload.fire_video }}" -o v_fire.mp4
          curl -L "${{ github.event.client_payload.rain_audio }}" -o a_rain.mp3
          curl -L "${{ github.event.client_payload.fire_audio }}" -o a_fire.mp3

          # 修正ポイント：
          # 1. 炎を scale でサイズ調整し、boxblur で端をボカす
          # 2. pad で背景と同じ 2752x1536 のサイズに広げ、位置を暖炉（160, 810）に固定
          # 3. [v_rain] と [fire_padded] を blend フィルターにしっかり2つ渡す
          ffmpeg -loop 1 -i background.png -i v_rain.mp4 -i v_fire.mp4 -i a_rain.mp3 -i a_fire.mp3 -filter_complex \
          "[1:v]scale=2752:1536,format=yuva420p,colorchannelmixer=aa=0.1[rain]; \
           [0:v][rain]overlay=shortest=1[v_rain]; \
           [2:v]scale=550:460,boxblur=15,format=yuva420p,pad=2752:1536:160:810:black[fire_padded]; \
           [v_rain][fire_padded]blend=all_mode='lighten':all_opacity=0.9,format=yuv420p[v_final]; \
           [3:a]pan=stereo|c0=0.8*c0|c1=0.4*c1[rain_a]; \
           [4:a]afade=t=in:st=2:d=5,pan=stereo|c0=0.3*c0|c1=0.9*c1[fire_a]; \
           [rain_a][fire_a]amix=inputs=2:duration=first[aout]" \
          -map "[v_final]" -map "[aout]" -t 60 -c:v libx264 -pix_fmt yuv420p -c:a aac final_video.mp4

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Nature-Canvas-Ultimate-Result
          path: final_video.mp4
