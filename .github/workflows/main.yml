name: Nature Canvas 4K Video Factory

on:
  repository_dispatch:
    types: [start-build]

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Download Sounds
        run: |
          # Pythonistaから送られてきたURLをダウンロード
          curl -L "${{ github.event.client_payload.fire_url }}" -o fire.mp3
          curl -L "${{ github.event.client_payload.rain_url }}" -o rain.mp3

      - name: Render High-Quality Video
        run: |
          # 1. 一番新しいmp4ファイルを自動で材料として選ぶ
          REAL_VIDEO=$(ls -t *.mp4 | grep -v output.mp4 | head -n 1)
          echo "Using video: $REAL_VIDEO"
          
          # 2. FFmpegで合成
          # -stream_loop -1: 映像も音も、指定時間まで無限ループさせる（音切れ解消）
          # [1:a]volume=1.0: 焚き火の音量はそのまま
          # [2:a]volume=0.3: 雨の音量を30%に絞る（バランス調整）
          # scale=3840:2160: 4Kにアップスケール（高画質化）
          # -crf 18: 最高クラスの画質設定
          ffmpeg -stream_loop -1 -i "$REAL_VIDEO" \
            -stream_loop -1 -i fire.mp3 \
            -stream_loop -1 -i rain.mp3 \
            -filter_complex "[1:a]volume=1.0[a1];[2:a]volume=0.3[a2];[a1][a2]amix=inputs=2:duration=first[aout]" \
            -map 0:v -map "[aout]" \
            -vf "scale=3840:2160:flags=lanczos" \
            -c:v libx264 -preset slow -crf 18 -t 60 -pix_fmt yuv420p output.mp4

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nature-Canvas-Final-Test
          path: output.mp4
